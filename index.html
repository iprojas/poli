<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>poli â€¢ AR Controller</title>
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    .wrap { display: grid; place-items: center; height: 100%; }
    .stack { display: grid; gap: 1rem; place-items: center; text-align: center; }
    img { max-width: min(90vw, 90vh); height: auto; }
    .hint { opacity: .8; font-size: .95rem; }
    .controls { display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; }
    .btn { cursor:pointer; padding:.6rem .9rem; border-radius:10px; border:1px solid #9995; background:#fff2; }
    .hide { display:none !important; }
    .status { position: fixed; top: .5rem; left: .5rem; font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; opacity:.7; }
    .stage { display:grid; place-items:center; }
  </style>
</head>
<body>
  <div class="status" id="status">status: boot</div>
  <div class="wrap">
    <div class="stack">
      <!-- QR stage -->
      <div class="stage" id="stage-qr">
        <div class="stack">
          <img id="qr-img" src="./qr.jpg" alt="Scan to open phone AR" />
          <div class="hint">
            Or tap: <a href="./phone/">/phone/</a>
          </div>
          <div class="controls">
            <button class="btn" id="forceStart">Force start (no socket)</button>
          </div>
        </div>
      </div>

      <!-- HIRO marker stage -->
      <div class="stage hide" id="stage-hiro">
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/1/16/Hiro_marker_ARjs.png"
          alt="HIRO marker (show this to phone camera)"
        />
        <div class="hint">Point your phone at this HIRO tag</div>
      </div>

      <!-- KANJI marker stage -->
      <div class="stage hide" id="stage-kanji">
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/d/d8/Kanji_marker_ARjs.png"
          alt="KANJI marker (show this to phone camera)"
        />
        <div class="hint">Now use this KANJI tag</div>
      </div>
    </div>
  </div>

  <!-- PieSocket browser SDK -->
  <script src="https://unpkg.com/piesocket-js@5"></script>
  <script>
    const statusEl = document.getElementById('status');
    const stageQR   = document.getElementById('stage-qr');
    const stageHiro = document.getElementById('stage-hiro');
    const stageKanji= document.getElementById('stage-kanji');
    const btnForce  = document.getElementById('forceStart');

    function setStatus(msg){ statusEl.textContent = 'status: ' + msg; }

    function show(el){
      [stageQR, stageHiro, stageKanji].forEach(x => x.classList.add('hide'));
      el.classList.remove('hide');
    }

    function startFlow(socket){
      // Step 1: show HIRO marker immediately
      show(stageHiro);
      socket && channel?.publish("show-hiro", {t: Date.now()});

      // Step 2: after 5s switch to KANJI and tell phone to show torus
      setTimeout(() => {
        show(stageKanji);
        socket && channel?.publish("show-kanji", {t: Date.now()});
      }, 5000);
    }

    // Fallback/manual mode
    btnForce.addEventListener('click', () => startFlow(false));

    // --- Realtime via PieSocket (demo cluster/no server required) ---
    // Their SDK defaults include apiKey='demo' and clusterId='demo'.
    // We set them explicitly for clarity. :contentReference[oaicite:5]{index=5}
    let channel = null;
    try {
      const piesocket = new PieSocket.default({
        apiKey: 'demo',
        clusterId: 'demo',
        consoleLogs: true,
        // notifySelf: 1 (default) so we can see our own publishes in dev if needed. :contentReference[oaicite:6]{index=6}
      });
      channel = piesocket.subscribe('poli-ar-global');

      channel.on('open', () => setStatus('socket open'));
      channel.on('error', (e) => setStatus('socket error'));
      channel.listen('phone-ready', () => {
        setStatus('phone-ready received');
        startFlow(true);
      });
    } catch (e) {
      setStatus('socket init failed; use Force start');
      console.error(e);
    }
  </script>
</body>
</html>
